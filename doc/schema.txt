-- 1. Identity & Auth
CREATE TABLE USER_ROLE (
    roleId INT PRIMARY KEY,
    roleName VARCHAR(50) NOT NULL
);

CREATE TABLE APP_USER (
    userId VARCHAR(36) PRIMARY KEY,
    email VARCHAR(255) NOT NULL,
    passwordHash VARCHAR(255) NOT NULL,
    roleId INT NOT NULL,
    isActive BOOLEAN DEFAULT TRUE,
    createdTimestamp TIMESTAMP NOT NULL
);

CREATE TABLE REFRESH_TOKEN (
    tokenId VARCHAR(36) PRIMARY KEY,
    userId VARCHAR(36) NOT NULL,
    token VARCHAR(255) NOT NULL,
    expiryDate TIMESTAMP NOT NULL,
    revoked BOOLEAN DEFAULT FALSE
);

-- 2. Business Profile
CREATE TABLE CUSTOMER (
    customerId VARCHAR(36) PRIMARY KEY,
    userId VARCHAR(36) NOT NULL,
    firstName VARCHAR(100),
    lastName VARCHAR(100),
    contactNo VARCHAR(20) NOT NULL
);

-- 3. Inventory & Pricing
CREATE TABLE INVENTORY_ITEM (
    itemId VARCHAR(50) PRIMARY KEY,
    availableStock INT NOT NULL,
    reservedStock INT NOT NULL
);

CREATE TABLE PRICING_CATALOG (
    itemId VARCHAR(50) NOT NULL,
    unitPrice DECIMAL(19,4) NOT NULL,
    createdTimestamp TIMESTAMP NOT NULL,
    PRIMARY KEY (itemId, createdTimestamp)
);

-- 4. Orders
CREATE TABLE ORDER_STATUS_LOOKUP (
    statusId INT PRIMARY KEY,
    statusName VARCHAR(50) NOT NULL
);

CREATE TABLE ORDERS (
    orderId VARCHAR(36) PRIMARY KEY,
    customerId VARCHAR(36) NOT NULL,
    statusId INT NOT NULL,
    createdTimestamp TIMESTAMP NOT NULL,
    updatedTimestamp TIMESTAMP NOT NULL
);

CREATE TABLE ORDER_ITEM (
    orderId VARCHAR(36) NOT NULL,
    itemId VARCHAR(50) NOT NULL,
    quantity INT NOT NULL,
    unitPrice DECIMAL(19,4) NOT NULL,
    PRIMARY KEY (orderId, itemId)
);

-- Link Auth to Roles
ALTER TABLE APP_USER 
ADD CONSTRAINT FK_USER_ROLE FOREIGN KEY (roleId) REFERENCES USER_ROLE(roleId);

-- Link Refresh Tokens to Users
ALTER TABLE REFRESH_TOKEN 
ADD CONSTRAINT FK_TOKEN_USER FOREIGN KEY (userId) REFERENCES APP_USER(userId);

-- Link Customer Profile to Auth User
ALTER TABLE CUSTOMER 
ADD CONSTRAINT FK_CUSTOMER_USER FOREIGN KEY (userId) REFERENCES APP_USER(userId);

-- Link Orders to Customer and Status
ALTER TABLE ORDERS 
ADD CONSTRAINT FK_ORDER_CUSTOMER FOREIGN KEY (customerId) REFERENCES CUSTOMER(customerId);

ALTER TABLE ORDERS 
ADD CONSTRAINT FK_ORDER_STATUS FOREIGN KEY (statusId) REFERENCES ORDER_STATUS_LOOKUP(statusId);

-- Link Order Items to Orders and Inventory
ALTER TABLE ORDER_ITEM 
ADD CONSTRAINT FK_ITEM_ORDER FOREIGN KEY (orderId) REFERENCES ORDERS(orderId);

ALTER TABLE ORDER_ITEM 
ADD CONSTRAINT FK_ITEM_INVENTORY FOREIGN KEY (itemId) REFERENCES INVENTORY_ITEM(itemId);

-- Link Pricing to Inventory
ALTER TABLE PRICING_CATALOG 
ADD CONSTRAINT FK_PRICING_INVENTORY FOREIGN KEY (itemId) REFERENCES INVENTORY_ITEM(itemId);

-- Uniqueness
ALTER TABLE APP_USER ADD CONSTRAINT UQ_USER_EMAIL UNIQUE (email);
ALTER TABLE CUSTOMER ADD CONSTRAINT UQ_CUSTOMER_CONTACT UNIQUE (contactNo);
ALTER TABLE REFRESH_TOKEN ADD CONSTRAINT UQ_TOKEN_STR UNIQUE (token);
ALTER TABLE USER_ROLE ADD CONSTRAINT UQ_ROLE_NAME UNIQUE (roleName);
ALTER TABLE ORDER_STATUS_LOOKUP ADD CONSTRAINT UQ_STATUS_NAME UNIQUE (statusName);

-- Logic Checks
ALTER TABLE INVENTORY_ITEM ADD CONSTRAINT CHK_AVAIL_STOCK CHECK (availableStock >= 0);
ALTER TABLE INVENTORY_ITEM ADD CONSTRAINT CHK_RES_STOCK CHECK (reservedStock >= 0);
ALTER TABLE INVENTORY_ITEM ADD CONSTRAINT CHK_STOCK_CONSISTENCY CHECK (availableStock >= reservedStock);

ALTER TABLE ORDER_ITEM ADD CONSTRAINT CHK_QTY_POS CHECK (quantity > 0);
ALTER TABLE ORDER_ITEM ADD CONSTRAINT CHK_PRICE_NON_NEG CHECK (unitPrice >= 0);
ALTER TABLE PRICING_CATALOG ADD CONSTRAINT CHK_CATALOG_PRICE CHECK (unitPrice >= 0);


