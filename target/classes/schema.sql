-- Create Logical Schema
CREATE SCHEMA IF NOT EXISTS ordermgmt;
SET search_path TO ordermgmt;

-- 1. Identity & Auth
CREATE TABLE IF NOT EXISTS USER_ROLE (
    roleId INT PRIMARY KEY,
    roleName VARCHAR(50) NOT NULL,
    CONSTRAINT UQ_ROLE_NAME UNIQUE (roleName)
);

CREATE TABLE IF NOT EXISTS APP_USER (
    userId VARCHAR(36) PRIMARY KEY,
    email VARCHAR(255) NOT NULL,
    passwordHash VARCHAR(255) NOT NULL,
    roleId INT NOT NULL,
    isActive BOOLEAN DEFAULT TRUE,
    createdTimestamp TIMESTAMP NOT NULL,
    CONSTRAINT UQ_USER_EMAIL UNIQUE (email),
    CONSTRAINT FK_USER_ROLE FOREIGN KEY (roleId) REFERENCES USER_ROLE(roleId)
);

CREATE TABLE IF NOT EXISTS REFRESH_TOKEN (
    tokenId VARCHAR(36) PRIMARY KEY,
    userId VARCHAR(36) NOT NULL,
    token VARCHAR(255) NOT NULL,
    expiryDate TIMESTAMP NOT NULL,
    revoked BOOLEAN DEFAULT FALSE,
    CONSTRAINT UQ_TOKEN_STR UNIQUE (token),
    CONSTRAINT FK_TOKEN_USER FOREIGN KEY (userId) REFERENCES APP_USER(userId)
);

-- 2. Business Profile
CREATE TABLE IF NOT EXISTS CUSTOMER (
    customerId VARCHAR(36) PRIMARY KEY,
    userId VARCHAR(36) NOT NULL,
    firstName VARCHAR(100),
    lastName VARCHAR(100),
    contactNo VARCHAR(20) NOT NULL,
    CONSTRAINT UQ_CUSTOMER_CONTACT UNIQUE (contactNo),
    CONSTRAINT FK_CUSTOMER_USER FOREIGN KEY (userId) REFERENCES APP_USER(userId)
);

-- 3. Inventory & Pricing
CREATE TABLE IF NOT EXISTS INVENTORY_ITEM (
    itemId VARCHAR(50) PRIMARY KEY,
    availableStock INT NOT NULL,
    reservedStock INT NOT NULL,
    CONSTRAINT CHK_AVAIL_STOCK CHECK (availableStock >= 0),
    CONSTRAINT CHK_RES_STOCK CHECK (reservedStock >= 0),
    CONSTRAINT CHK_STOCK_CONSISTENCY CHECK (availableStock >= reservedStock)
);

CREATE TABLE IF NOT EXISTS PRICING_CATALOG (
    itemId VARCHAR(50) NOT NULL,
    unitPrice DECIMAL(19,4) NOT NULL,
    createdTimestamp TIMESTAMP NOT NULL,
    PRIMARY KEY (itemId, createdTimestamp),
    CONSTRAINT CHK_CATALOG_PRICE CHECK (unitPrice >= 0),
    CONSTRAINT FK_PRICING_INVENTORY FOREIGN KEY (itemId) REFERENCES INVENTORY_ITEM(itemId)
);

-- 4. Orders
CREATE TABLE IF NOT EXISTS ORDER_STATUS_LOOKUP (
    statusId INT PRIMARY KEY,
    statusName VARCHAR(50) NOT NULL,
    CONSTRAINT UQ_STATUS_NAME UNIQUE (statusName)
);

CREATE TABLE IF NOT EXISTS ORDERS (
    orderId VARCHAR(36) PRIMARY KEY,
    customerId VARCHAR(36) NOT NULL,
    statusId INT NOT NULL,
    createdTimestamp TIMESTAMP NOT NULL,
    updatedTimestamp TIMESTAMP NOT NULL,
    CONSTRAINT FK_ORDER_CUSTOMER FOREIGN KEY (customerId) REFERENCES CUSTOMER(customerId),
    CONSTRAINT FK_ORDER_STATUS FOREIGN KEY (statusId) REFERENCES ORDER_STATUS_LOOKUP(statusId)
);

CREATE TABLE IF NOT EXISTS ORDER_ITEM (
    orderId VARCHAR(36) NOT NULL,
    itemId VARCHAR(50) NOT NULL,
    quantity INT NOT NULL,
    unitPrice DECIMAL(19,4) NOT NULL,
    PRIMARY KEY (orderId, itemId),
    CONSTRAINT CHK_QTY_POS CHECK (quantity > 0),
    CONSTRAINT CHK_PRICE_NON_NEG CHECK (unitPrice >= 0),
    CONSTRAINT FK_ITEM_ORDER FOREIGN KEY (orderId) REFERENCES ORDERS(orderId),
    CONSTRAINT FK_ITEM_INVENTORY FOREIGN KEY (itemId) REFERENCES INVENTORY_ITEM(itemId)
);
